name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write

jobs:
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for thorough scanning

      - name: Determine BASE and HEAD commits
        id: determine-commits
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, use the base branch as BASE and PR head as HEAD
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            SCAN_TYPE="diff"
          elif [ "${{ github.event_name }}" == "push" ]; then
            # For pushes, use the previous commit as BASE and current commit as HEAD
            if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              BASE="${{ github.event.before }}"
              HEAD="${{ github.event.after }}"
              SCAN_TYPE="diff"
            else
              # First commit or no previous commit, scan from default branch
              BASE="${{ github.event.repository.default_branch }}"
              HEAD="${{ github.sha }}"
              SCAN_TYPE="diff"
            fi
          else
            # For scheduled runs, scan the entire repository (no BASE/HEAD comparison)
            SCAN_TYPE="full"
          fi
          
          # Check if BASE and HEAD are the same (only for diff scans)
          if [ "$SCAN_TYPE" == "diff" ] && [ -n "$BASE" ] && [ "$BASE" == "$HEAD" ]; then
            echo "⚠️ BASE and HEAD commits are the same. Skipping scan."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "BASE=$BASE" >> $GITHUB_OUTPUT
          echo "HEAD=$HEAD" >> $GITHUB_OUTPUT
          echo "SCAN_TYPE=$SCAN_TYPE" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Run TruffleHog (diff scan)
        if: steps.determine-commits.outputs.skip != 'true' && steps.determine-commits.outputs.SCAN_TYPE == 'diff'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ steps.determine-commits.outputs.BASE }}
          head: ${{ steps.determine-commits.outputs.HEAD }}
          extra_args: --only-verified

      - name: Run TruffleHog (full repository scan)
        if: steps.determine-commits.outputs.SCAN_TYPE == 'full'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ""
          head: HEAD
          extra_args: --only-verified

  github-secret-scanning:
    name: GitHub Secret Scanning Alert
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for common secret patterns
        run: |
          echo "Checking for common secret patterns..."
          # Check for common patterns that might indicate secrets
          if grep -r -E "(api[_-]?key|secret[_-]?key|password|token|credential)" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" --include="*.env*" . | grep -v "node_modules" | grep -v ".git" | grep -v "dist" | grep -v "SECRET" | grep -v "API_KEY" | grep -v "example" | grep -v "placeholder" | grep -v "your_" | grep -v "dummy"; then
            echo "⚠️ Warning: Potential secret patterns found. Please review."
            echo "This is a basic check. Ensure no actual secrets are committed."
            exit 0  # Don't fail the build, just warn
          else
            echo "✅ No obvious secret patterns found."
          fi

